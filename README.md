Receita-WS
================

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

Para tal, ele acessa o servi√ßo web [Receita
WS](https://anatel365.sharepoint.com/sites/WikiAnatel/SitePages/Web-Service--ReceitaWS-.aspx?OR=Teams-HL&CT=1660241010872&clickparams=eyJBcHBOYW1lIjoiVGVhbXMtRGVza3RvcCIsIkFwcFZlcnNpb24iOiIyNy8yMjA3MDMwMDgxNSIsIkhhc0ZlZGVyYXRlZFVzZXIiOmZhbHNlfQ%3D%3D)
desenvolvido na Anatel. Este por sua vez √© um encapsulamento, com cache
em banco, do Servi√ßo Web
[Infoconv](https://acesso.infoconv.receita.fazenda.gov.br/docInfoconv/),
disponibilizado pela Serpro/Receita Federal, por meio de conv√™nio
firmado com a Anatel.

## Instala√ß√£o

### python

Caso n√£o tenha o python instalado, baixe a vers√£o para a sua plataforma
neste [link](https://www.python.org/downloads/) e siga as instru√ß√µes.

‚ùó Alternativamente, para uma plataforma de desenvolvimento mais
vers√°til recomendamos que seja instalado o
[miniconda](https://docs.conda.io/en/latest/miniconda.html), que √© uma
vers√£o m√≠nima do Anaconda.

‚ö° Para uma vers√£o otimizada do *miniconda*, com excelentes *defaults*,
recomendamos ainda que seja instalado o
[miniforge](https://github.com/conda-forge/miniforge/releases),

### Ambiente Virtual

Primeiramente √© recomendado a cria√ß√£o de ambiente virtual para instalar
o m√≥dulo, assim a vers√£o python deste e suas depend√™ncias n√£o afetam a
instala√ß√£o do python padr√£o:

**Modo 1 - Utilizando o m√≥dulo venv (dispon√≠vel em qualquer instala√ß√£o
padr√£o do python3):**

``` bash
python -m venv <pasta>
```

Desse modo ser√° criado o ambiente virtual na `<pasta>`

**Para ativar o ambiente virtual**:

**Windows**

Utilizando o Prompt de Comando: `cmd.exe`

    <pasta>\Scripts\activate.bat

Utilizando o `PowerShell`:

    <pasta>\Scripts\Activate.ps1

**Linux e MacOS**

    source <pasta>/bin/activate

**Modo 2 (Recomendado) - Utilizando o conda (dispon√≠vel em qualquer uma
das instala√ß√µes: `Anaconda | Miniconda | Miniforge`):**

    conda create -n <nome> python=3.10 -y

Desse modo ser√° criado um ambiente virtual com o nome `<nome>` criado na
pasta interna do conda.

**Para ativar o ambiente virtual `conda`:**

``` bash
conda activate <nome>
```

### Instala√ß√£o do m√≥dulo `receitaws`

Com o ambiente virtual criado e ativado, em qualquer um dos modos
mostrados no par√°grafo anterior, basta efetuar o comando:

    python -m pip install git+https://git.anatel.gov.br/rsilva/receitaws.git

> ‚òù Como este √© um servi√ßo de uso exclusivo na rede interna da Anatel e
> por logins autorizados, a instala√ß√£o √© feita diretamente pelo
> reposit√≥rio:

## Como utilizar

A biblioteca `nbdev` possui somente 1 m√≥dulo `consultas`, cuja API
principal √© a fun√ß√£o `requisitar_em_lote`:

``` python
from receitaws.consultas import requisitar_em_lote
```

------------------------------------------------------------------------

### requisitar_em_lote

>      requisitar_em_lote (filename:str, cpf_usuario:str, ambiente:str='ds',
>                          origem:str=None, cache:int=36, saida:str=None)

L√™ o arquivo `filename` com um CPF \| CPNJ por linha. Faz a requisi√ß√£o
no `ambiente` do receita-ws e salva os resultados em `saida`

|             | **Type** | **Default** | **Details**                                               |
|-------------|----------|-------------|-----------------------------------------------------------|
| filename    | str      |             | Arquivo texto de entrada: 1 CPF \| CNPJ por linha         |
| cpf_usuario | str      |             | CPF do usu√°rio requisitante                               |
| ambiente    | str      | ds          | Ambiente onde realizar a requisi√ß√£o: ds \| hm \| su \| pd |
| origem      | str      | None        | Texto com identifica√ß√£o da requisi√ß√£o: e.g.¬†‚ÄòTeste‚Äô       |
| cache       | int      | 36          | Tempo de expira√ß√£o do cache em meses                      |
| saida       | str      | None        | Arquivo de sa√≠da da requisi√ß√£o                            |
| **Returns** | **None** |             |                                                           |

> ‚ö†Ô∏è Como arquivo de entrada √© esperado um arquivo *texto*,
> e.g.¬†`csv | txt | tsv etc...` com 1 registro por linha!

``` python
cpf_usuario = input('Digite seu CPF para Identifica√ß√£o: ')
requisitar_em_lote(filename=r'D:\Code\receitaws\dados\cpf.csv', 
                     cpf_usuario=cpf_usuario, 
                     ambiente='ds',
                     origem='Teste DS',
                     cache=3,
                     saida=r'D:\Code\receitaws\dados\resultados_cpf.csv')
```

**Arquivo de Sa√≠da**

O formato do arquivo de sa√≠da √© automaticamente identificado pela
extens√£o do argumento `saida`, os valores poss√≠veis s√£o
`csv | xlsx | html | md`, para salvamento em formato tabular, ou no
formato `json`. Caso seja fornecido uma extens√£o n√£o suportada ou *n√£o*
seja fornecido um nome de arquivo de sa√≠da, ser√° salvo um `csv` na pasta
onde √© feita a requisi√ß√£o.

> üíØ Todos os dados retornados pelo web service s√£o salvos!

``` python
resultados = pd.read_csv(r'D:\Code\receitaws\dados\resultados_cpf.csv')
resultados.iloc[:, 1:] # Ocultar o CPF requisitado
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>nome</th>
      <th>situacaoCadastral.codigo</th>
      <th>situacaoCadastral.valor</th>
      <th>paisResidencia.residenteExterior</th>
      <th>paisResidencia.codigoPais</th>
      <th>nomeMae</th>
      <th>dataNascimento</th>
      <th>sexo.codigo</th>
      <th>sexo.valor</th>
      <th>ocupacao.naturezaOcupacaoCodigo</th>
      <th>...</th>
      <th>telefone.ddd</th>
      <th>telefone.numero</th>
      <th>unidadeAdministrativaCodigo</th>
      <th>anoObito</th>
      <th>estrangeiro</th>
      <th>tituloEleitor</th>
      <th>dataAtualizacao</th>
      <th>dataRegistroAnatel</th>
      <th>resultado</th>
      <th>erro</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Tuwpoxtzyzzruazdjdsqmaewylowhy</td>
      <td>2</td>
      <td>Suspensa</td>
      <td>True</td>
      <td>0</td>
      <td>Sjflu Ifgemqkhdjvpgcjewylowhy</td>
      <td>1937-10-25</td>
      <td>1</td>
      <td>Masculino</td>
      <td>36</td>
      <td>...</td>
      <td>25</td>
      <td>31297214</td>
      <td>1008514</td>
      <td>0</td>
      <td>False</td>
      <td>0</td>
      <td>1962-02-17</td>
      <td>2022-08-16</td>
      <td>CPF encontrado</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Tow Dh Vrmadfgixfxaxqupjkfp</td>
      <td>8</td>
      <td>Nula</td>
      <td>True</td>
      <td>0</td>
      <td>Bvgoxicrewhewdrt</td>
      <td>1917-06-28</td>
      <td>2</td>
      <td>Feminino</td>
      <td>5</td>
      <td>...</td>
      <td>25</td>
      <td>97620714</td>
      <td>7431014</td>
      <td>0</td>
      <td>False</td>
      <td>0</td>
      <td>1964-12-23</td>
      <td>2022-08-16</td>
      <td>CPF encontrado</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Tuwpoxtzyzzruazdjdsqmaewylowhy</td>
      <td>2</td>
      <td>Suspensa</td>
      <td>True</td>
      <td>0</td>
      <td>Sjflu Ifgemqkhdjvpgcjewylowhy</td>
      <td>1937-10-25</td>
      <td>1</td>
      <td>Masculino</td>
      <td>36</td>
      <td>...</td>
      <td>25</td>
      <td>31297214</td>
      <td>1008514</td>
      <td>0</td>
      <td>False</td>
      <td>0</td>
      <td>1962-02-17</td>
      <td>2022-08-16</td>
      <td>CPF encontrado</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Tow Dh Vrmadfgixfxaxqupjkfp</td>
      <td>8</td>
      <td>Nula</td>
      <td>True</td>
      <td>0</td>
      <td>Bvgoxicrewhewdrt</td>
      <td>1917-06-28</td>
      <td>2</td>
      <td>Feminino</td>
      <td>5</td>
      <td>...</td>
      <td>25</td>
      <td>97620714</td>
      <td>7431014</td>
      <td>0</td>
      <td>False</td>
      <td>0</td>
      <td>1964-12-23</td>
      <td>2022-08-16</td>
      <td>CPF encontrado</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Tuwpoxtzyzzruazdjdsqmaewylowhy</td>
      <td>2</td>
      <td>Suspensa</td>
      <td>True</td>
      <td>0</td>
      <td>Sjflu Ifgemqkhdjvpgcjewylowhy</td>
      <td>1937-10-25</td>
      <td>1</td>
      <td>Masculino</td>
      <td>36</td>
      <td>...</td>
      <td>25</td>
      <td>31297214</td>
      <td>1008514</td>
      <td>0</td>
      <td>False</td>
      <td>0</td>
      <td>1962-02-17</td>
      <td>2022-08-16</td>
      <td>CPF encontrado</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Tow Dh Vrmadfgixfxaxqupjkfp</td>
      <td>8</td>
      <td>Nula</td>
      <td>True</td>
      <td>0</td>
      <td>Bvgoxicrewhewdrt</td>
      <td>1917-06-28</td>
      <td>2</td>
      <td>Feminino</td>
      <td>5</td>
      <td>...</td>
      <td>25</td>
      <td>97620714</td>
      <td>7431014</td>
      <td>0</td>
      <td>False</td>
      <td>0</td>
      <td>1964-12-23</td>
      <td>2022-08-16</td>
      <td>CPF encontrado</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Tuwpoxtzyzzruazdjdsqmaewylowhy</td>
      <td>2</td>
      <td>Suspensa</td>
      <td>True</td>
      <td>0</td>
      <td>Sjflu Ifgemqkhdjvpgcjewylowhy</td>
      <td>1937-10-25</td>
      <td>1</td>
      <td>Masculino</td>
      <td>36</td>
      <td>...</td>
      <td>25</td>
      <td>31297214</td>
      <td>1008514</td>
      <td>0</td>
      <td>False</td>
      <td>0</td>
      <td>1962-02-17</td>
      <td>2022-08-16</td>
      <td>CPF encontrado</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Tow Dh Vrmadfgixfxaxqupjkfp</td>
      <td>8</td>
      <td>Nula</td>
      <td>True</td>
      <td>0</td>
      <td>Bvgoxicrewhewdrt</td>
      <td>1917-06-28</td>
      <td>2</td>
      <td>Feminino</td>
      <td>5</td>
      <td>...</td>
      <td>25</td>
      <td>97620714</td>
      <td>7431014</td>
      <td>0</td>
      <td>False</td>
      <td>0</td>
      <td>1964-12-23</td>
      <td>2022-08-16</td>
      <td>CPF encontrado</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Tuwpoxtzyzzruazdjdsqmaewylowhy</td>
      <td>2</td>
      <td>Suspensa</td>
      <td>True</td>
      <td>0</td>
      <td>Sjflu Ifgemqkhdjvpgcjewylowhy</td>
      <td>1937-10-25</td>
      <td>1</td>
      <td>Masculino</td>
      <td>36</td>
      <td>...</td>
      <td>25</td>
      <td>31297214</td>
      <td>1008514</td>
      <td>0</td>
      <td>False</td>
      <td>0</td>
      <td>1962-02-17</td>
      <td>2022-08-16</td>
      <td>CPF encontrado</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Tow Dh Vrmadfgixfxaxqupjkfp</td>
      <td>8</td>
      <td>Nula</td>
      <td>True</td>
      <td>0</td>
      <td>Bvgoxicrewhewdrt</td>
      <td>1917-06-28</td>
      <td>2</td>
      <td>Feminino</td>
      <td>5</td>
      <td>...</td>
      <td>25</td>
      <td>97620714</td>
      <td>7431014</td>
      <td>0</td>
      <td>False</td>
      <td>0</td>
      <td>1964-12-23</td>
      <td>2022-08-16</td>
      <td>CPF encontrado</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>10 rows √ó 30 columns</p>
</div>

**Ambientes**

A mesma requisi√ß√£o pode ser feita nos ambientes: \* Desenvolvimento:
`ds` (padr√£o) \* Homologa√ß√£o: `hm` \* Sustenta√ß√£o: `su` \* Produ√ß√£o:
`pd`

**Tipo de Requisi√ß√£o: `CPF` ou `CNPJ`**

> üß† O tipo de requisi√ß√£o √© automaticamente identificado pelo tamanho do
> identificador no arquivo:

-   11 üëâ `CPF`
-   14 üëâ `CNPJ`

**Utiliza√ß√£o do Cache em Banco**

O argumento `cache` √© o n√∫mero de meses que devemos considerar antes de
fazer a requisi√ß√£o.

Caso o intervalo de tempo entre a data da requisi√ß√£o e a data de
atualiza√ß√£o do registro em banco corporativo for inferior ao `cache`, o
registro do banco √© retornado em lugar de se fazer a requisi√ß√£o ao
Infoconv da receita federal üòé

> Isso foi uma solu√ß√£o para evitar requisi√ß√µes, e por conseguinte
> cobran√ßas desnecess√°rias, de registros que j√° est√£o com atualiza√ß√£o
> recente em banco ü§ë

### Script em linha de comando

A API principal `requisitar_em _lote` pode ser executada
programaticamente em linha de comando:

<img src="cli.png" alt="Requisi√ß√£o em Lote na Linha de Comando" />
